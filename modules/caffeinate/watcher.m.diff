5d4
< #import "../../LuaSkinThread.h"
91,94c90,91
< @interface LST_CaffeinateWatcher : NSObject
< @property        caffeinatewatcher_t* object;
< @property (weak) NSThread           *myMainThread ;
< 
---
> @interface CaffeinateWatcher : NSObject
> @property caffeinatewatcher_t* object;
98c95
< @implementation LST_CaffeinateWatcher
---
> @implementation CaffeinateWatcher
101,102c98
<         _object       = object;
<         _myMainThread = [NSThread currentThread] ;
---
>         self.object = object;
109c105
<     LuaSkin *skin = LST_getLuaSkin();
---
>     LuaSkin *skin = [LuaSkin shared];
112c108
<     [skin pushLuaRef:LST_getRefTable(skin, USERDATA_TAG, refTable) ref:self.object->fn];
---
>     [skin pushLuaRef:refTable ref:self.object->fn];
121,125d116
< - (void)onProperThread:(NSDictionary *)arguments {
<     [self callback:[arguments  objectForKey:@"dict"]
<          withEvent:[[arguments objectForKey:@"event"] unsignedIntValue]];
< }
< 
127,133c118
<     [self performSelector:@selector(onProperThread:)
<                  onThread:_myMainThread
<                withObject:@{
<                               @"dict"  : [notification userInfo] ? [notification userInfo] : [NSNull null],
<                               @"event" : @(didWake)
<                           }
<             waitUntilDone:YES];
---
>     [self callback:[notification userInfo] withEvent:didWake];
137,143c122
<     [self performSelector:@selector(onProperThread:)
<                  onThread:_myMainThread
<                withObject:@{
<                               @"dict"  : [notification userInfo] ? [notification userInfo] : [NSNull null],
<                               @"event" : @(willSleep)
<                           }
<             waitUntilDone:YES];
---
>     [self callback:[notification userInfo] withEvent:willSleep];
147,153c126
<     [self performSelector:@selector(onProperThread:)
<                  onThread:_myMainThread
<                withObject:@{
<                               @"dict"  : [notification userInfo] ? [notification userInfo] : [NSNull null],
<                               @"event" : @(willPowerOff)
<                           }
<             waitUntilDone:YES];
---
>     [self callback:[notification userInfo]  withEvent:willPowerOff];
157,163c130
<     [self performSelector:@selector(onProperThread:)
<                  onThread:_myMainThread
<                withObject:@{
<                               @"dict"  : [notification userInfo] ? [notification userInfo] : [NSNull null],
<                               @"event" : @(screensDidSleep)
<                           }
<             waitUntilDone:YES];
---
>     [self callback:[notification userInfo] withEvent:screensDidSleep];
167,173c134
<     [self performSelector:@selector(onProperThread:)
<                  onThread:_myMainThread
<                withObject:@{
<                               @"dict"  : [notification userInfo] ? [notification userInfo] : [NSNull null],
<                               @"event" : @(screensDidWake)
<                           }
<             waitUntilDone:YES];
---
>     [self callback:[notification userInfo] withEvent:screensDidWake];
177,183c138
<     [self performSelector:@selector(onProperThread:)
<                  onThread:_myMainThread
<                withObject:@{
<                               @"dict"  : [notification userInfo] ? [notification userInfo] : [NSNull null],
<                               @"event" : @(sessionDidResignActive)
<                           }
<             waitUntilDone:YES];
---
>     [self callback:[notification userInfo] withEvent:sessionDidResignActive];
187,193c142
<     [self performSelector:@selector(onProperThread:)
<                  onThread:_myMainThread
<                withObject:@{
<                               @"dict"  : [notification userInfo] ? [notification userInfo] : [NSNull null],
<                               @"event" : @(sessionDidBecomeActive)
<                           }
<             waitUntilDone:YES];
---
>     [self callback:[notification userInfo] withEvent:sessionDidBecomeActive];
197,203c146
<     [self performSelector:@selector(onProperThread:)
<                  onThread:_myMainThread
<                withObject:@{
<                               @"dict"  : [notification userInfo] ? [notification userInfo] : [NSNull null],
<                               @"event" : @(screensaverDidStart)
<                           }
<             waitUntilDone:YES];
---
>     [self callback:[notification userInfo] withEvent:screensaverDidStart];
207,213c150
<     [self performSelector:@selector(onProperThread:)
<                  onThread:_myMainThread
<                withObject:@{
<                               @"dict"  : [notification userInfo] ? [notification userInfo] : [NSNull null],
<                               @"event" : @(screensaverWillStop)
<                           }
<             waitUntilDone:YES];
---
>     [self callback:[notification userInfo] withEvent:screensaverWillStop];
217,223c154
<     [self performSelector:@selector(onProperThread:)
<                  onThread:_myMainThread
<                withObject:@{
<                               @"dict"  : [notification userInfo] ? [notification userInfo] : [NSNull null],
<                               @"event" : @(screensaverDidStop)
<                           }
<             waitUntilDone:YES];
---
>     [self callback:[notification userInfo] withEvent:screensaverDidStop];
227,233c158
<     [self performSelector:@selector(onProperThread:)
<                  onThread:_myMainThread
<                withObject:@{
<                               @"dict"  : [notification userInfo] ? [notification userInfo] : [NSNull null],
<                               @"event" : @(screensDidLock)
<                           }
<             waitUntilDone:YES];
---
>     [self callback:[notification userInfo] withEvent:screensDidLock];
237,243c162
<     [self performSelector:@selector(onProperThread:)
<                  onThread:_myMainThread
<                withObject:@{
<                               @"dict"  : [notification userInfo] ? [notification userInfo] : [NSNull null],
<                               @"event" : @(screensDidUnlock)
<                           }
<             waitUntilDone:YES];
---
>     [self callback:[notification userInfo] withEvent:screensDidUnlock];
259c178
<     LuaSkin *skin = LST_getLuaSkin();
---
>     LuaSkin *skin = [LuaSkin shared];
266c185
<     caffeinateWatcher->fn = [skin luaRef:LST_getRefTable(skin, USERDATA_TAG, refTable)];
---
>     caffeinateWatcher->fn = [skin luaRef:refTable];
268c187
<     caffeinateWatcher->obj = (__bridge_retained void*) [[LST_CaffeinateWatcher alloc] initWithObject:caffeinateWatcher];
---
>     caffeinateWatcher->obj = (__bridge_retained void*) [[CaffeinateWatcher alloc] initWithObject:caffeinateWatcher];
276c195
< static void register_observer(LST_CaffeinateWatcher* observer) {
---
> static void register_observer(CaffeinateWatcher* observer) {
336c255
< static void unregister_observer(LST_CaffeinateWatcher* observer) {
---
> static void unregister_observer(CaffeinateWatcher* observer) {
364c283
<     LuaSkin *skin = LST_getLuaSkin();
---
>     LuaSkin *skin = [LuaSkin shared];
374c293
<     register_observer((__bridge LST_CaffeinateWatcher*)caffeinateWatcher->obj);
---
>     register_observer((__bridge CaffeinateWatcher*)caffeinateWatcher->obj);
388c307
<     LuaSkin *skin = LST_getLuaSkin();
---
>     LuaSkin *skin = [LuaSkin shared];
404c323
<     LuaSkin *skin = LST_getLuaSkin();
---
>     LuaSkin *skin = [LuaSkin shared];
410c329
<     caffeinateWatcher->fn = [skin luaUnref:LST_getRefTable(skin, USERDATA_TAG, refTable) ref:caffeinateWatcher->fn];
---
>     caffeinateWatcher->fn = [skin luaUnref:refTable ref:caffeinateWatcher->fn];
412c331
<     LST_CaffeinateWatcher* object = (__bridge_transfer LST_CaffeinateWatcher*)caffeinateWatcher->obj;
---
>     CaffeinateWatcher* object = (__bridge_transfer CaffeinateWatcher*)caffeinateWatcher->obj;
471,477c390,391
<     LuaSkin *skin = LST_getLuaSkin();
< 
<     LST_setRefTable(skin, USERDATA_TAG, refTable,
<         [skin registerLibraryWithObject:USERDATA_TAG
<                               functions:caffeinateLib
<                           metaFunctions:metaGcLib
<                         objectFunctions:metaLib]) ;
---
>     LuaSkin *skin = [LuaSkin shared];
>     refTable = [skin registerLibraryWithObject:USERDATA_TAG functions:caffeinateLib metaFunctions:metaGcLib objectFunctions:metaLib];
